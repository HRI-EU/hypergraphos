var window,generatorsConfig;let rg,apg,lpg;if(window)rg=new ReplaceGenerator,apg=new ArrayPatternGenerator,lpg=new LinePatternGenerator;else{const a="./",b=(rg=require(a+"/ReplaceGenerator"),require(a+"/ArrayPatternGenerator"));generatorsConfig=require(a+"/generatorsConfig.js"),apg=b.apg,lpg=b.lpg}const tgGeneratorList={Replace:rg,LinePattern:lpg,ArrayPattern:apg};class TemplateGenerator{constructor(t,e){this.parentGenerator=e,this.setTemplate(t),this.clearOutput(),this.parameterList=[],this.replaceList=[],this.foundReplace=[],this.conf={beginTag:"# Begin ",endTag:"# End ",defineTag:"# Define ",insertTag:"# Insert ",loopBeginTag:"# Loop Begin ",loopEndTag:"# Loop End "},generatorsConfig("",this.conf),this.property={language:"JavaScript",isKeepBlockOnNoData:!1}}setLanguage(t){this.property.language=t,generatorsConfig(t,this.conf)}setProperty(t,e){"language"===t?this.setLanguage(e):this.property[t]=e}setParameterList(t){this.parameterList=t||[]}setTemplate(t){"string"==typeof t&&(t=t.split("\n")),this.originalTemplate=t,this._setBuffer(t)}getTemplate(){return this.originalTemplate}getTemplateStr(){return this.originalTemplate.join("\n")}isTemplateEmpty(){return 0==this.bufferInfo.templateLen}getOutput(){return this.output}getOutputStr(){return this.output.join("\n")}clearOutput(){this.output=[]}clearParameterList(){this.parameterList=[]}clearParent(){this.parentGenerator=null}addGenerator(t,e){tgGeneratorList[t]=e}testModel(r,t){var s=[],e=r.length;for(let n=0;n<e;++n){var a=r[n];if("string"==typeof a){var o=a;let i=[];if(a.startsWith("Loop_Begin_")){if(n<e-1){++n;let e=[];t[o]&&(e=t[o]());for(let t=0;t<e.length;++t){var l=e[t],l=(i=this.testModel(r[n],l),{});l[`${o}[${t}]`]=i,s.push(l)}}}else{t[o]&&(i=t[o]());a={};a[o]=i,s.push(a)}}}return s}getTemplateStructure(t){for(var e=[];!this.bufferInfo.isEOT;){var i=this._getNextBufferLineStr();if(!this.bufferInfo.isEOT){if(t&&-1!=i.indexOf(t))break;var n,i=i.match(this.conf.blockLineExp);i&&i[1]&&(n=(i=i[1]).substring(2,i.length-2).replaceAll(" ","_"),e.push(n),i.startsWith(this.conf.defineTag)||i.startsWith(this.conf.insertTag)||(i.startsWith(this.conf.beginTag)?(n=this.conf.endTag+i.substring(this.conf.beginTag.length),0<(n=this.getTemplateStructure(n)).length&&e.push(n)):i.startsWith(this.conf.loopBeginTag)&&(n=this.conf.loopEndTag+i.substring(this.conf.loopBeginTag.length),0<(i=this.getTemplateStructure(n)).length)&&e.push(i)))}}return e}process(e){for(;!this.bufferInfo.isEOT;){var i=this._getNextBufferLineStr();if(!this.bufferInfo.isEOT){var n=i.match(this.conf.blockLineExp);if(n&&n[1]){n=n[1];const h=this._getLineIndentation(i);let t=tgGeneratorList.LinePattern;var r=i.match(this.conf.blockParamExp),s=(t.setDefaultParams(),r&&r[1]&&(-1!=(s=(r=r[1]).indexOf(","))?(a=r.substring(0,s),t=tgGeneratorList[a],a=r.substring(s+1),t.setParams(a)):(t=tgGeneratorList[r]).setDefaultParams()),n.substring(2,n.length-2).trim().replaceAll(" ","_"));if(n.startsWith(this.conf.defineTag)){var a=this.extractNextLine(!1);e[s]&&(null!=(r=e[s]())?(t.doReplace(a,r),a.generate()):this.property.isKeepBlockOnNoData&&this.generate(a.getTemplate()))}else if(n.startsWith(this.conf.insertTag)){if(e[s]){var o=e=>{for(let t=0;t<e.length;++t)e[t]=" ".repeat(h)+e[t]},r=e[s]();if(null!=r&&0<r.length)if(Array.isArray(r[0]))for(const g of r)h&&o(g),this.generate(g);else h&&o(r),this.generate(r);else this.property.isKeepBlockOnNoData}}else if(n.startsWith(this.conf.beginTag)){r=this.conf.endTag+n.substring(this.conf.beginTag.length),r=this.extractNextLineBlock(!1,"",r);e[s]&&(null!=(l=e[s]())?(t.doReplace(r,l),r.generate()):this.property.isKeepBlockOnNoData&&this.generate(r.getTemplate()))}else if(n.startsWith(this.conf.loopBeginTag)){var l=this.conf.loopEndTag+n.substring(this.conf.loopBeginTag.length),f=this.extractNextLineBlock(!1,"",l);if(e[s]){r=e[s]();if(null!=r)for(const u of r)f.process(u),f.generate();else this.property.isKeepBlockOnNoData&&this.generate(f.getTemplate())}}else this.output.push(i)}else this.output.push(i)}}}generate(t){if(t)this.output=this.output.concat(t);else{for(;!this.bufferInfo.isEOT;){var e=this._getNextBufferLineStr();this.bufferInfo.isEOT||this.output.push(e)}this.parentGenerator&&(this.parentGenerator.generate(this.output),this.clearOutput()),this.setTemplate(this.originalTemplate)}}extractNextLine(t,e,i){i=void 0===i||i;var n={paramList:[],lineList:[]};let r=null,s=0;if(e&&(r=this._getStartLine(e),t)&&(s=this._getLineIndentation(r)),this.bufferInfo.isEOT||null!=(r=(i||null==r)&&(r=this._getEndLine(null,n),this.bufferInfo.isEOT)?null:r)&&n.lineList.push(r),s)for(let t=0;t<n.lineList.length;++t)n.lineList[t]=n.lineList[t].substring(s);e=new TemplateGenerator(n.lineList,this);return e.setParameterList(n.paramList),e}extractNextLineBlock(t,e,i,n){n=void 0===n||n;var r={paramList:[],lineList:[]};let s=null,a=0;if(e&&(s=this._getStartLine(e),t)&&(a=this._getLineIndentation(s)),!this.bufferInfo.isEOT&&(n||null==s||r.lineList.push(s),null==s||i&&-1==s.indexOf(i))&&(s=this._getEndLine(i,r),this.bufferInfo.isEOT?(this.output=this.output.concat(r.lineList),r.lineList=[]):n||r.lineList.push(s)),a)for(let t=0;t<r.lineList.length;++t)r.lineList[t]=r.lineList[t].substring(a);e=new TemplateGenerator(r.lineList,this);return e.setParameterList(r.paramList),e}extractNextBlock(t,e,i){var n,r,s,a={paramList:[],lineList:[]};let o=this._getStartLine(t);this.bufferInfo.isEOT||(n=this.bufferInfo.index,t=o.indexOf(t),s=o.substring(0,t),a.lineList.push(o.substring(t)),e&&-1==o.indexOf(e)&&(o=this._getEndLine(e,a),this.bufferInfo.isEOT?(this.output=this.output.concat(lineBlock),lineBlock=[]):(r=this.bufferInfo.index,t=o.indexOf(e)+e.length,s=s+i+o.substring(t),a.lineList.push(o.substring(0,t)),this.bufferInfo.template.splice(n,r-n+1,s),this.bufferInfo.templateLen=this.bufferInfo.template.length,this.bufferInfo.index=n-1)));for(let t=0;t<a.lineList.length;++t)a.lineList[t]=a.lineList[t].trimStart();e=new TemplateGenerator(a.lineList,this);return e.setParameterList(a.paramList),e}_setBuffer(t){this.bufferInfo={template:(t=t||[]).slice(0),templateLen:t.length,index:-1,isEOT:0==t.length}}_getStartLine(t){let e="";if(!this.bufferInfo.isEOT)for(;!this.bufferInfo.isEOT;){var i=this._getNextBufferLineStr();if(t&&-1!==i.indexOf(t)||!t){e=i;break}this.output.push(i)}return e}_getEndLine(t,e){let i="",n=!0;if(!this.bufferInfo.isEOT)for(;!this.bufferInfo.isEOT;){var r=this._getNextBufferLineStr(),s=r.trim();if(n&&s.startsWith(this.conf.blockTArgBeginExp)){if(e){var s=this.conf.blockTArgBeginExp.length,a=r.indexOf(this.conf.blockTArgBeginExp),o=" ".repeat(a);let t=r.length;this.conf.blockTArgEndExp&&-1!=(l=r.lastIndexOf(this.conf.blockTArgEndExp))&&(t=l);var l=r.substring(a+s,t);e.paramList.push(o+l)}}else{if(t&&-1!==r.indexOf(t)||!t){i=r;break}e&&e.lineList.push(r),n=!1}}return i}_getNextBufferLineStr(){let t="";var e;return this.bufferInfo.isEOT||((e=++this.bufferInfo.index)<=this.bufferInfo.templateLen-1?t=this.bufferInfo.template[e]:this.bufferInfo.isEOT=!0),t}_getLineIndentation(t){return t?t.search(/\S/):0}}window||(module.exports=TemplateGenerator);