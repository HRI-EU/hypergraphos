!function(){const t=require("node-static");var{}=require("http");module.exports=new class{constructor(){this.d5={GET:[],POST:[]}}s2(e){return new t.Server(e)}a3(e,r,s){var t="GET";this.d5[t].push({method:t,virtualPath:e,reqHandler:(e,t)=>{e.addListener("end",()=>{s&&s(e,t),r.serve(e,t)}).resume()}}),this.s7(t)}a6(e,s){var t="POST";this.d5[t].push({method:t,virtualPath:e,reqHandler:(e,t)=>{let r="";e.addListener("data",e=>{r+=e}).resume(),e.addListener("end",()=>{s.serve(e,t,r)}).resume()}}),this.s7(t)}g4(){return(e,t)=>this.h8(e,t)}h8(e,t){try{switch(e.method){case"GET":this.m9(e,t);break;case"POST":this.m10(e,t)}}catch(e){}}m9(e,t){var r=e.url;for(const s of this.d5.GET)if(r.startsWith(s.virtualPath)){"/"!=s.virtualPath&&(e.url=r.substring(s.virtualPath.length)),s.reqHandler(e,t);break}}m10(e,t){var r="POST",s=e.url;for(const i of this.d5[r]){s.startsWith(i.virtualPath)&&(e.url=e.url.substring(i.virtualPath.length),i.reqHandler(e,t));break}}s7(e){this.d5[e].sort((e,t)=>e.virtualPath<t.virtualPath?1:e.virtualPath>t.virtualPath?-1:0)}};const v=require("fs");var r;i&&v.readdirSync(i).forEach(e=>{});const d=require("../serverConfig.js"),f=require("child_process")["exec"],s=(d.server.ip=(r=require("os").networkInterfaces(),i=Object.keys(r).map(function(e){return r[e]}),(i=[].concat.apply([],i).filter(function(e){return"IPv4"==e.family&&0==e.internal})).length?i[0].address:"0.0.0.0"),d.client.server={ip:d.server.ip},JSON.stringify(d,null,2));function e(e,t){}var i=d.client.host.name,i=d.server.clientPath+`/configs/${i}_config.js`,a="/* \n  NOTE: this config is auto generated by server process\n  DO NOT MODIFY THIS FILE\n*/\nconst config = "+JSON.stringify(d.client,null,2)+";",i=(v.writeFileSync(i,a,"utf8"),require("http")),a=module.exports,i=i.createServer(a.g4());function P(e){var t=e.substring(0,e.lastIndexOf("/")),e=e.substring(e.lastIndexOf("/")+1),r=-1==(r=e.lastIndexOf("."))?e.length:r;return{pathName:t,fileName:e.substring(0,r),extension:e.substring(r+1)}}function m(e,t,r){return t.endsWith("/")||(t+="/"),(e=e.startsWith("/")?e:"/"+e).startsWith(t)?(t=t.length,r+"/"+e.substring(t)):e}a.a3("/library",a.s2(d.server.libPath),e),a.a3("/fileServer",a.s2(d.server.dataRoot),e),a.a3("/executeScript",new class{constructor(e){this.virtualPath="/executeScript/",this.virtualPathRel="executeScript/",this.realPath=e}serve(e,s){let r=m(e.url,this.virtualPath,this.realPath);var i="",a="",e=r.indexOf("?");if(-1!=e){var n=decodeURI(r.substring(e+1));if(r=r.substring(0,e),n){var l=n.split("&"),h=l.length;let t=!(a=i="");for(let e=0;e<h;++e){var u,o=l[e],c=o.indexOf("=");0<c?(i=i+`\\"${u=o.substring(0,c)}\\":\\"${c=o.substring(c+1)}\\"`+(e!=h-1?",":""),a=a+`"${u}":"${c}"`+(e!=h-1?",":"")):(t=!1,i=a=a+" "+o)}t&&(i=`{${i}}`,a=`{${a}}`)}}e=P(r);if("js"==e.extension){var n=require(this.realPath+r);let t="";try{t=n(a)}catch(e){t="Error, could not start ",this.realPath,r}s.writeHead(200,{"Content-Type":"text/text"}),s.end(t)}else{var e="win32"==d.server.scriptPlatform?".bat":".sh",n=(r="win32"==d.server.scriptPlatform?r.replaceAll("/","\\"):r)+e,e=this.realPath+n;v.existsSync(e)?(n=`cd ${this.realPath} && .${n} `+i,n=n,f(n,(e,t,r)=>{t?(s.writeHead(200,{"Content-Type":"text/text"}),s.end(t)):e&&(s.writeHead(400,{"Content-Type":"text/text"}),s.end("Error: "+e.message))})):(e="Script not exist "+e,s.writeHead(200,{"Content-Type":"text/text"}),s.end(e))}}}(d.server.scriptPath),e),a.a3("/",a.s2(d.server.clientPath),e),a.a3("/status",new class{serve(e,t){t.writeHead(200,{"Content-Type":"text/html"}),t.end(`<html><body>
          <h1>MDDFileServer Running!</h1><br>
          <h2> Configuration</h2>
          <pre>${s}</pre>
          </body></html>`)}}),a.a3("/fileStatus",new class{constructor(e){this.virtualPath="/fileServer/",this.realPath=e}serve(e,s){let t=m(e.url,this.virtualPath,this.realPath);e=t.indexOf("?");-1!=e&&(t=t.substring(0,e)),t=this.realPath+t,v.stat(t,(e,t)=>{s.writeHead(200,{"Content-Type":"text/json"});var r={},e=(e||(r.mtime=t.mtime,r.atime=t.atime,r.ctime=t.ctime,r.birthtime=t.birthtime),JSON.stringify(r));s.end(e)})}}(d.server.dataRoot)),a.a6("/fileServer",new class{constructor(e){this.virtualPath="/fileServer/",this.virtualPathRel="fileServer/",this.realPath=e}serve(e,t,r){try{var s=JSON.parse(r);if(s&&s.url&&(s.url.startsWith(this.virtualPathRel)&&(s.url="/"+s.url),s.url.startsWith(this.virtualPath))){var i,a=m(s.url,this.virtualPath,this.realPath),n=P(a);v.existsSync(n.pathName)||v.mkdirSync(n.pathName,{recursive:!0});let e=s.source||"";if(d.server.debugOnFileContentOn&&"json"==n.extension)try{var l=JSON.parse(e);e=JSON.stringify(l,null,2)}catch(e){}"base64"==s.sourceEncoding?(i=Buffer.from(e,"base64"),v.writeFileSync(a,i)):v.writeFileSync(a,e,"utf8")}}catch(e){}t.end("post received")}}(d.server.dataRoot)),a.a3("/test",a.s2(d.server.testPath),e),i.listen(d.server.webServerPort,function(){d.server.webServerProtocol,d.server.webServerName,d.server.webServerPort})}();